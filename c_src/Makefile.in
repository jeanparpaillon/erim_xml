top_srcdir=@top_srcdir@
top_builddir=@top_builddir@
CC= @CC@

HAVE_LIBXML2 = @HAVE_LIBXML2@
HAVE_EXPAT = @HAVE_EXPAT@

builddir = $(REBAR_BUILD_DIR)/lib/erim_xml/priv/lib
ports =
ifeq ($(HAVE_LIBXML2),true)
ports += $(builddir)/erim_xml_libxml2.so
endif
ifeq ($(HAVE_EXPAT),true)
ports += $(builddir)/erim_xml_expat.so $(builddir)/erim_xml_expat_legacy.so
endif

ERLANG_ROOT_DIR = @ERLANG_ROOT_DIR@
ERLANG_ERTS_VER = @ERLANG_ERTS_VER@
ERLANG_LIB_DIR_erl_interface = @ERLANG_LIB_DIR_erl_interface@
ERLANG_LIB_VER_erl_interface = @ERLANG_LIB_VER_erl_interface@

ERLCFLAGS = -I$(ERLANG_ROOT_DIR)/erts-$(ERLANG_ERTS_VER)/include -I$(ERLANG_LIB_DIR_erl_interface)/include
CFLAGS = -O3 -std=c99 -finline-functions -Wall -Wmissing-prototypes -fPIC $(ERLCFLAGS)
LDLIBS = -L$(ERLANG_LIB_DIR_erl_interface)/lib -lerl_interface -lei -lei_st
LDFLAGS = -shared

EXPAT_CFLAGS = @EXPAT_CFLAGS@
EXPAT_LIBS = @EXPAT_LIBS@
EXPAT_LDFLAGS = @EXPAT_LDFLAGS@

xml2_CFLAGS = @xml2_CFLAGS@
xml2_LIBS = @xml2_LIBS@

all: $(ports)

$(builddir)/erim_xml_expat.so: erim_driver.o erim_xml.o erim_xml_expat.o
	@mkdir -p $(builddir)
	$(CC) $^ $(LDFLAGS) $(LDLIBS) $(EXPAT_LDFLAGS) $(EXPAT_LIBS) -o $@

$(builddir)/erim_xml_expat_legacy.so: erim_driver.o erim_xml.o erim_xml_legacy.o
	@mkdir -p $(builddir)
	$(CC) $^ $(LDFLAGS) $(LDLIBS) $(EXPAT_LDFLAGS) $(EXPAT_LIBS) -o $@

$(builddir)/erim_xml_libxml2.so: erim_driver.o erim_xml.o erim_xml_libxml2.o
	@mkdir -p $(builddir)
	$(CC) $^ $(LDFLAGS) $(LDLIBS) $(xml2_LIBS) -o $@

%.o: %.c
	$(CC) $(CFLAGS) $(xml2_CFLAGS) $(EXPAT_CFLAGS) -c $<

clean:
	-test -n "$(ports)" && rm -f $(ports)

.PHONY: all compile clean
